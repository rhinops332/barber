<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HairBoss - Book Appointment</title>
<style>
  body {
    font-family: {{ design.body_font_family|default("Arial, sans-serif") }};
    max-width: 700px;
    margin: 30px auto;
    padding: 20px;
    background: {{ design.body_background_color|default("#f0f4ff") }};
    color: #2c3e50;
  }
  h1 {
    font-size: {{ design.heading_font_size|default("32px") }};
    font-family: {{ design.heading_font_family|default("'Georgia', serif") }};
    color: {{ design.heading_color|default("#2980b9") }};
  }
  h2 {
    font-size: {{ design.subheading_font_size|default("24px") }};
    font-family: {{ design.subheading_font_family|default("'Verdana', sans-serif") }};
    color: {{ design.subheading_color|default("#555") }};
  }
  #days-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
  }
  .day-btn {
    font-family: {{ design.day_button_font_family|default("'Tahoma', sans-serif") }};
    font-size: {{ design.day_button_text_size|default("15px") }};
    padding: 12px 0;
    border: none;
    border-radius: {{ design.day_button_shape|default("10px") }};
    background: {{ design.day_button_color|default("#3498db") }};
    color: {{ design.day_button_text_color|default("white") }};
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .day-btn:hover, .day-btn.active { background:#2980b9; }
  #availability { text-align:center; margin-bottom:20px; }
  .slot-btn {
    font-family: {{ design.slot_button_font_family|default("'Verdana', sans-serif") }};
    font-size: {{ design.slot_button_text_size|default("14px") }};
    padding: 8px 14px;
    margin: 5px;
    border: none;
    border-radius: {{ design.slot_button_shape|default("6px") }};
    background: {{ design.slot_button_color|default("#2ecc71") }};
    color: {{ design.slot_button_text_color|default("white") }};
    cursor: pointer;
    transition: transform 0.15s ease;
  }
  .slot-btn.unavailable { background:#bbb; cursor:default; }
  .slot-btn:hover:not(.unavailable){ background:#27ae60; }
  .slot-btn.selected {
    animation: growBtn .2s forwards;
    border:2px solid black;
    box-shadow:0 0 8px rgba(0,0,0,0.4);
  }
  @keyframes growBtn { from{transform:scale(1);} to{transform:scale(1.2);} }
  #form-container {
    display:none;
    margin-top:20px;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 8px #ccc;
  }
  form input,form select {
    width:100%;
    padding:10px;
    margin-bottom:12px;
    border-radius:6px;
    border:1px solid #ccc;
  }
  form button {
    width:100%;
    padding:12px;
    background:#2980b9;
    color:white;
    border:none;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
  }
  form button:hover{background:#1f6391;}
  #response{text-align:center;font-weight:bold;margin-bottom:10px;}
  #booking-details {
    margin-top:20px;
    background:#fff;
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 8px #ccc;
    max-width:400px;
    margin-left:auto;
    margin-right:auto;
    text-align:right;
    direction:rtl;
    font-size:16px;
    display:none;
  }
  #booking-details h3 {margin-bottom:10px;color:#2980b9;}
  #botBtn {
    display:block;
    margin:20px auto 0;
    padding:12px;
    background:#27ae60;
    color:white;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    width:260px;
  }
  #bot-window {
    position:fixed;
    bottom:20px;
    right:20px;
    width:320px;
    height:400px;
    background:white;
    border:1px solid #ccc;
    border-radius:10px;
    box-shadow:0 0 14px rgba(0,0,0,0.18);
    padding:10px;
    box-sizing:border-box;
    display:none;
    resize:both;
    font-size:14px;
    z-index:10000;
  }
  #bot-header {
    position:relative;
    text-align:center;
    border-bottom:1px solid #eee;
    margin-bottom:8px;
    padding-bottom:6px;
  }
  #bot-expand,#bot-close {
    position:absolute;
    background:none;
    border:none;
    font-size:20px;
    cursor:pointer;
    color:#555;
    top:8px;
  }
  #bot-expand{left:8px;}
  #bot-close{right:8px;}
  #bot-messages {
    height:290px;
    overflow-y:auto;
    border:1px solid #ddd;
    padding:8px;
    background:#fafafa;
    border-radius:6px;
    margin-bottom:10px;
  }
  #bot-input{display:flex;gap:8px;}
  #bot-input input {
    flex-grow:1;
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
  }
  #bot-input button {
    background:#27ae60;
    border:none;
    border-radius:6px;
    padding:8px 14px;
    color:white;
    font-weight:bold;
    cursor:pointer;
  }
  #bot-input button:hover{background:#1e8449;}
</style>
</head>
<body>

<h1>{{design.heading_text}}</h1>
<h2>{{design.subheading_text}}</h2>

<div id="response"></div>

<div id="days-buttons"></div>
<div id="availability">
  <h3 id="selected-date-title" style="text-align:center;margin-bottom:10px;"></h3>
  <div id="slots-container" style="text-align:center;"></div>
</div>

<div id="booking-details">
  <p><b>שעה:</b> <span id="selected-time"></span></p>
  <p><b>שם מלא:</b> <span id="detail-name"></span></p>
  <p><b>מספר טלפון:</b> <span id="detail-phone"></span></p>
</div>

<div id="selected-time-display"
     style="margin-top:10px;font-weight:bold;font-size:16px;color:#2980b9;min-height:24px;"></div>

<div id="form-container">
  <form id="bookingForm">
    <input type="text" id="name" placeholder="Full Name" required />
    <input type="text" id="phone" placeholder="Phone Number" required />
    <input type="hidden" id="date" name="date" />
    <input type="hidden" id="time" name="time" />
    <button type="submit">Book Appointment</button>
  </form>
</div>

<button id="botBtn" onclick="toggleBotWindow()">Need Help? Ask Our AI Bot</button>

<div id="bot-window">
  <div id="bot-header">
    <button id="bot-expand" onclick="resizeBot()">↕</button>
    <h3>Ask our AI Bot</h3>
    <button id="bot-close" onclick="toggleBotWindow()">✖</button>
  </div>
  <div id="bot-messages"></div>
  <div id="bot-input">
    <input type="text" id="bot-user-input" placeholder="Type your question..." />
    <button onclick="sendBotMessage()">Send</button>
  </div>
</div>

<script>
let allDates=[],availabilityData={},chosenDate='',chosenTime='',selectedButton=null;

function formatHebrewDay(d){
  const dt=new Date(d);
  return ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'][dt.getDay()];
}
async function loadAvailability(){
  const res=await fetch('/availability');
  const data=await res.json();
  availabilityData=data;
  allDates=Object.keys(data);
  createDayButtons();
  if(allDates.length)showDayAvailability(allDates[0]);
}
function createDayButtons(){
  const c=document.getElementById('days-buttons');
  c.innerHTML='';
  allDates.forEach(dateStr=>{
    const w=document.createElement('div');
    w.style.textAlign='center';
    const lbl=document.createElement('div');
    lbl.textContent=formatHebrewDay(dateStr);
    lbl.style.fontSize='14px';
    lbl.style.marginBottom='4px';
    const btn=document.createElement('button');
    btn.textContent=new Date(dateStr).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit'});
    btn.className='day-btn';
    btn.onclick=()=>{
      showDayAvailability(dateStr);
      Array.from(document.getElementsByClassName('day-btn')).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      clearBookingDetailsAndForm();
    };
    w.append(lbl,btn);
    c.appendChild(w);
  });
  if(c.children.length)c.querySelector('.day-btn').classList.add('active');
}
function clearBookingDetailsAndForm(){
  document.getElementById('booking-details').style.display='none';
  if(selectedButton){selectedButton.classList.remove('selected');selectedButton=null;}
  document.getElementById('form-container').style.display='none';
  document.getElementById('response').textContent='';
  chosenTime='';
  document.getElementById('date').value='';
  document.getElementById('time').value='';
  document.getElementById('selected-time-display').textContent='';
}
function showDayAvailability(date){
  chosenDate=date;
  const c=document.getElementById('slots-container');
  document.getElementById('selected-date-title').textContent=
    `${formatHebrewDay(date)} - ${new Date(date).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit'})}`;
  c.innerHTML='';
  const slots=availabilityData[date]?.times||availabilityData[date]||[];
  if(!slots.length){c.innerHTML='<p>אין שעות פנויות</p>';return;}
  slots.forEach(slot=>{
    const b=document.createElement('button');
    b.textContent=slot.time;
    b.className=slot.available?'slot-btn available':'slot-btn unavailable';
    b.disabled=!slot.available;
    b.onclick=()=>{
      if(selectedButton)selectedButton.classList.remove('selected');
      b.classList.add('selected');selectedButton=b;
      chosenTime=slot.time;
      document.getElementById('date').value=chosenDate;
      document.getElementById('time').value=chosenTime;
      document.getElementById('selected-time-display').textContent=`השעה שנבחרה: ${slot.time}`;
      document.getElementById('form-container').style.display='block';
      document.getElementById('response').textContent='';
    };
    c.appendChild(b);
  });
}
document.getElementById('bookingForm').onsubmit=async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const date=document.getElementById('date').value;
  const time=document.getElementById('time').value;
  if(!date||!time){alert('You must select a time slot.');return;}
  const res=await fetch('/book',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,phone,date,time})});
  const data=await res.json();
  const r=document.getElementById('response');
  if(data.message){
    r.style.color='green';r.textContent=data.message;
    await loadAvailability();
    document.getElementById('form-container').style.display='none';
  }else{
    r.style.color='red';r.textContent=data.error;
  }
};
function toggleBotWindow(){
  const b=document.getElementById('bot-window');
  b.style.display=b.style.display==='block'?'none':'block';
}
async function sendBotMessage(){
  const inp=document.getElementById('bot-user-input');
  const msg=inp.value.trim();if(!msg)return;
  const msgs=document.getElementById('bot-messages');
  msgs.innerHTML+=`<div><b>You:</b> ${msg}</div>`;inp.value='';
  const res=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
  const data=await res.json();
  if(data.answer)msgs.innerHTML+=`<div><b>Bot:</b> ${data.answer}</div>`;
  msgs.scrollTop=msgs.scrollHeight;
}
function resizeBot(){
  const b=document.getElementById('bot-window');
  if(b.style.width==='520px'){b.style.width='320px';b.style.height='400px';}
  else{b.style.width='520px';b.style.height='520px';}
}
loadAvailability();
</script>

</body>
</html>
