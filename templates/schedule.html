<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ניהול שגרה שבועית - HairBoss</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f8f9fa;
      color: #2c3e50;
      direction: rtl;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .day-button {
      display: inline-block;
      padding: 10px 16px;
      margin: 6px;
      border: none;
      background: #2980b9;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .day-button.active {
      background: #1c5986;
    }

    .day-section {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
    }

    .time-slot {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      background: #e9f7ef;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 6px;
    }

    .time-slot input[type="time"] {
      width: 90px;
      padding: 5px;
    }

    .time-slot button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-edit {
      background-color: #f39c12;
      color: white;
    }

    .btn-delete {
      background-color: #e74c3c;
      color: white;
    }

    .btn-toggle-day {
      background: #c0392b;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-add-slot {
      background: #2ecc71;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }

    #save-status {
      margin-top: 10px;
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>ניהול שגרה שבועית</h1>

<div id="day-buttons"></div>

<div id="day-sections"></div>

<script>
const hebDays = ['שני','שלישי','רביעי','חמישי','שישי','שבת','ראשון'];
// מיפוי day_key למחרוזת יום
const dayMap = {0:'שני',1:'שלישי',2:'רביעי',3:'חמישי',4:'שישי',5:'שבת',6:'ראשון'};

let weeklySchedule = {};  // ייטען מהשרת
let activeDay = null;

async function fetchSchedule() {
  const res = await fetch('/admin/weekly');
  const html = await res.text();
  // לא טוענים מה-html, נטעין דרך API:
  // נעשה fetch נוסף לראוט המתאים JSON:
  // מכיוון שאין ראוט נפרד JSON - נשתמש בראוט שמחזיר json
  // אבל כרגע אין כזה. לכן נטען weekly_schedule מה-Jinja
  // במקום זאת, נוסיף כאן טען סטטי:
  // ליתר דיוק, נשלב את weekly_schedule מהשרת באמצעות Jinja:
}

function init() {
  // weeklySchedule מגיע מהשרת כמשתנה שמוטמע ע"י Jinja
  weeklySchedule = {{ weekly_schedule|tojson }};
  
  buildDayButtons();
  buildDaySections();
  openDay(0);
}

function buildDayButtons() {
  const container = document.getElementById('day-buttons');
  container.innerHTML = '';
  for(let i=0; i<7; i++) {
    const btn = document.createElement('button');
    btn.textContent = dayMap[i];
    btn.className = 'day-button';
    btn.dataset.dayKey = i;
    btn.onclick = () => openDay(i);
    container.appendChild(btn);
  }
}

function buildDaySections() {
  const container = document.getElementById('day-sections');
  container.innerHTML = '';

  for(let i=0; i<7; i++) {
    const dayKey = i;
    const dayName = dayMap[i];
    const section = document.createElement('div');
    section.className = 'day-section';
    section.dataset.dayKey = dayKey;
    section.style.display = 'none';

    // כפתור כיבוי/הפעלה יום
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn-toggle-day';
    const enabled = (weeklySchedule[dayKey] && weeklySchedule[dayKey].length > 0);
    toggleBtn.textContent = enabled ? 'כבה יום זה' : 'הפעל יום זה';
    toggleBtn.onclick = () => toggleDay(dayKey, toggleBtn, section);
    section.appendChild(toggleBtn);

    // מכולת שעות
    const slotContainer = document.createElement('div');
    slotContainer.className = 'slots-container';
    section.appendChild(slotContainer);

    // בנה את השעות
    if(enabled) {
      weeklySchedule[dayKey].forEach(time => {
        addSlot(slotContainer, time);
      });
    }

    // כפתור הוספת שעה חדשה
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add-slot';
    addBtn.textContent = '+ הוסף שעה';
    addBtn.onclick = () => addSlot(slotContainer);
    section.appendChild(addBtn);

    container.appendChild(section);
  }
}

function openDay(dayKey) {
  activeDay = dayKey;
  document.querySelectorAll('.day-button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.day-section').forEach(s => s.style.display = 'none');
  document.querySelector(`.day-button[data-day-key="${dayKey}"]`).classList.add('active');
  document.querySelector(`.day-section[data-day-key="${dayKey}"]`).style.display = 'block';
}

function addSlot(container, timeValue = '') {
  const slot = document.createElement('div');
  slot.className = 'time-slot';

  const input = document.createElement('input');
  input.type = 'time';
  input.value = timeValue;
  input.disabled = true;
  slot.appendChild(input);

  const editBtn = document.createElement('button');
  editBtn.className = 'btn-edit';
  editBtn.textContent = 'ערוך';
  editBtn.onclick = () => {
    input.disabled = !input.disabled;
    if(!input.disabled) input.focus();
  }
  slot.appendChild(editBtn);

  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'שמור';
  saveBtn.style.backgroundColor = '#27ae60';
  saveBtn.style.color = 'white';
  saveBtn.style.border = 'none';
  saveBtn.style.borderRadius = '6px';
  saveBtn.style.marginRight = '10px';
  saveBtn.style.cursor = 'pointer';
  saveBtn.onclick = async () => {
    if(!input.value) {
      alert('אנא הזן שעה חוקית');
      return;
    }
    await saveEditSlot(activeDay, slot, input.value, input.dataset.oldValue);
    input.dataset.oldValue = input.value;
    input.disabled = true;
  };
  slot.appendChild(saveBtn);

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'btn-delete';
  deleteBtn.textContent = 'X';
  deleteBtn.onclick = async () => {
    if (confirm('בטוח שברצונך למחוק שעה זו?')) {
      await deleteSlot(activeDay, input.value);
      slot.remove();
    }
  };
  slot.appendChild(deleteBtn);

  input.dataset.oldValue = timeValue;

  container.appendChild(slot);
}

async function toggleDay(dayKey, button, section) {
  const enabled = (weeklySchedule[dayKey] && weeklySchedule[dayKey].length > 0);
  const newEnabled = !enabled;

  // שלח לשרת את השינוי
  const res = await fetch('/weekly_toggle_day', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({day_key: dayKey.toString(), enabled: newEnabled})
  });
  const data = await res.json();

  if (res.ok) {
    // עדכן בנתונים המקומיים
    if(newEnabled) {
      if(!weeklySchedule[dayKey]) weeklySchedule[dayKey] = [];
    } else {
      weeklySchedule[dayKey] = [];
    }
    // עדכן כפתור ומראה שעות
    button.textContent = newEnabled ? 'כבה יום זה' : 'הפעל יום זה';
    const slotContainer = section.querySelector('.slots-container');
    slotContainer.innerHTML = '';
    if(newEnabled) {
      // אפשר להשאיר ריק
    }
  } else {
    alert('שגיאה בעדכון יום');
  }
}

async function saveEditSlot(dayKey, slotElement, newTime, oldTime) {
  // אם oldTime ריק -> הוספה, אחרת עריכה
  const isNew = !oldTime;

  if(isNew) {
    // הוסף שעה חדשה
    const res = await fetch('/weekly_schedule', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action: 'add', day_key: dayKey.toString(), time: newTime})
    });
    const data = await res.json();
    if(res.ok) {
      weeklySchedule[dayKey].push(newTime);
      weeklySchedule[dayKey].sort();
      alert('השעה נוספה בהצלחה');
    } else {
      alert('שגיאה בהוספת שעה: ' + (data.error || ''));
      slotElement.remove();
    }
  } else {
    // עריכה
    const res = await fetch('/weekly_schedule', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action: 'edit', day_key: dayKey.toString(), time: oldTime, new_time: newTime})
    });
    const data = await res.json();
    if(res.ok) {
      // עדכן במערכת המקומית
      const times = weeklySchedule[dayKey];
      const idx = times.indexOf(oldTime);
      if(idx >= 0) {
        times[idx] = newTime;
        times.sort();
      }
      alert('השעה עודכנה בהצלחה');
    } else {
      alert('שגיאה בעריכת שעה: ' + (data.error || ''));
      // החזר לשעה הישנה
      slotElement.querySelector('input[type="time"]').value = oldTime;
    }
  }
}

async function deleteSlot(dayKey, time) {
  const res = await fetch('/weekly_schedule', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({action: 'remove', day_key: dayKey.toString(), time: time})
  });
  const data = await res.json();
  if(res.ok) {
    const idx = weeklySchedule[dayKey].indexOf(time);
    if(idx >= 0) {
      weeklySchedule[dayKey].splice(idx, 1);
    }
    alert('השעה נמחקה בהצלחה');
  } else {
    alert('שגיאה במחיקת שעה: ' + (data.error || ''));
  }
}

// הפעל התחלה
window.onload = init;
</script>

</body>
</html>
