<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<title>עיצוב עסק</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: Arial, sans-serif; transition: background-color 0.2s; }
.btn { transition: transform .12s ease, box-shadow .12s ease; cursor:pointer; padding:10px; }
.btn:hover { transform: translateY(-2px); }
.selected-outline { outline: 3px solid #f59e0b; outline-offset: 3px; }
.small-label { font-size: 0.9rem; color: #555; }
</style>
</head>
<body>
<script>
  window.__DESIGN = {{ design_settings | tojson | safe }};
</script>

<div class="flex h-screen">
  <div class="w-3/4 p-6 overflow-auto">
    <div class="mb-6">
      <h1 id="mainTitle" class="text-2xl font-bold"></h1>
      <h2 id="subTitle" class="text-lg"></h2>
    </div>

    <div class="mb-6">
      <div class="grid grid-cols-7 gap-3">
        {% for i in range(7) %}
          <button class="btn day-btn">DAY</button>
        {% endfor %}
      </div>
    </div>

    <div>
      <div class="grid grid-cols-5 gap-3">
        {% for i in range(20) %}
          <button class="btn slot-btn">HOUR</button>
        {% endfor %}
      </div>
    </div>
  </div>

  <aside class="w-1/4 bg-white p-6 border-l border-gray-300">
    <h3 class="text-lg font-semibold mb-4">אפשרויות</h3>
    <div class="mb-4">
      <label class="block small-label mb-1">צבע רקע</label>
      <input id="pageBg" type="color" class="w-full h-10 p-0 border">
    </div>
    <div id="editorArea" class="text-gray-600">
      <p id="editorHint">לחץ על כותרת, יום או שעה כדי לערוך.</p>
    </div>
    <button id="saveBtn" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">💾 שמור</button>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const DS = window.__DESIGN || {};
  const mainTitle = document.getElementById('mainTitle');
  const subTitle = document.getElementById('subTitle');
  const pageBg = document.getElementById('pageBg');
  const dayButtons  = document.querySelectorAll('.day-btn');
  const slotButtons = document.querySelectorAll('.slot-btn');

  // ערכי ברירת מחדל
  document.body.style.backgroundColor = DS.body_background_color || '#f3f4f6';
  mainTitle.textContent = DS.heading_text || 'שם העסק';
  subTitle.textContent = DS.subheading_text || 'בחרו תור לקביעת פגישה';
  mainTitle.style.fontFamily = DS.heading_font_family || 'Georgia, serif';
  mainTitle.style.fontSize = DS.heading_font_size || '32px';
  mainTitle.style.color = DS.heading_color || '#2980b9';
  subTitle.style.fontFamily = DS.subheading_font_family || 'Verdana, sans-serif';
  subTitle.style.fontSize = DS.subheading_font_size || '18px';
  subTitle.style.color = DS.subheading_color || '#555';

  // סגנון כפתורים
  function styleButtons(selector, color, textColor, radius, font, textSize, btnHeight) {
    document.querySelectorAll(selector).forEach(btn=>{
      btn.style.backgroundColor = color;
      btn.style.color = textColor;
      btn.style.borderRadius = radius;
      btn.style.fontFamily = font;
      btn.style.fontSize = textSize;
      btn.style.height = btnHeight;
      btn.style.padding = `0 ${Math.round(parseInt(btnHeight)/2)}px`;
    });
  }
  styleButtons('.day-btn', DS.day_button_color || '#3498db', DS.day_button_text_color || '#fff',
               DS.day_button_shape || '12px', DS.day_button_font_family || 'Tahoma',
               DS.day_button_text_size || '15px', DS.day_button_height || '36px');
  styleButtons('.slot-btn', DS.slot_button_color || '#2ecc71', DS.slot_button_text_color || '#fff',
               DS.slot_button_shape || '8px', DS.slot_button_font_family || 'Verdana',
               DS.slot_button_text_size || '14px', DS.slot_button_height || '36px');

  pageBg.value = DS.body_background_color || '#f3f4f6';
  pageBg.addEventListener('input', e=>document.body.style.backgroundColor=e.target.value);

  // -------- עריכה --------
  const editorArea = document.getElementById('editorArea');
  function clearOutline(){
    document.querySelectorAll('.day-btn,.slot-btn,#mainTitle,#subTitle')
      .forEach(el=>el.classList.remove('selected-outline'));
  }

  function renderEditor(type, el){
    clearOutline();
    if(el) el.classList.add('selected-outline');
    editorArea.innerHTML='';

    if(type==='title'||type==='subtitle'){
      const t = type==='title'?mainTitle:subTitle;
      editorArea.innerHTML=`<div>
        <label class="small-label mb-1">טקסט</label>
        <input id="titleText" class="w-full border p-2" value="${t.textContent}">
        <label class="small-label mt-3 mb-1">צבע</label>
        <input id="titleColor" type="color" class="w-full h-10 p-0 border" value="${t.style.color}">
        <label class="small-label mt-3 mb-1">גודל טקסט</label>
        <div class="flex items-center gap-2">
          <button type="button" id="textMinus" class="btn px-2 py-1">–</button>
          <input id="titleSizeNumber" type="number" class="w-16 border p-1 text-center" value="${parseInt(t.style.fontSize)}">
          <button type="button" id="textPlus" class="btn px-2 py-1">+</button>
        </div>
        <label class="small-label mt-3 mb-1">פונט</label>
        <select id="titleFont" class="w-full border p-2">
          <option value="Arial">Arial</option>
          <option value="Tahoma">Tahoma</option>
          <option value="Rubik">Rubik</option>
          <option value="Verdana">Verdana</option>
        </select>
      </div>`;

      document.getElementById('titleText').addEventListener('input', e=>t.textContent=e.target.value);
      document.getElementById('titleColor').addEventListener('input', e=>t.style.color=e.target.value);
      const titleSizeInput = document.getElementById('titleSizeNumber');
      document.getElementById('textMinus').addEventListener('click', ()=>{
        titleSizeInput.value = Math.max(1, parseInt(titleSizeInput.value)-1);
        t.style.fontSize = titleSizeInput.value+'px';
      });
      document.getElementById('textPlus').addEventListener('click', ()=>{
        titleSizeInput.value = parseInt(titleSizeInput.value)+1;
        t.style.fontSize = titleSizeInput.value+'px';
      });
      titleSizeInput.addEventListener('input', ()=>{
        let v = parseInt(titleSizeInput.value); if(isNaN(v)||v<1)v=1;
        titleSizeInput.value=v;
        t.style.fontSize=v+'px';
      });
      document.getElementById('titleFont').addEventListener('change', e=>t.style.fontFamily=e.target.value);

    } else if(type==='day' || type==='slot'){
      const targetButtons = type==='day' ? dayButtons : slotButtons;
      const sample = targetButtons[0];
      editorArea.innerHTML=`<div>
        <label class="small-label mb-1">צבע רקע</label>
        <input id="btnBg" type="color" class="w-full h-10 p-0 border" value="${getComputedStyle(sample).backgroundColor}">
        <label class="small-label mt-3 mb-1">צבע טקסט</label>
        <input id="btnColor" type="color" class="w-full h-10 p-0 border" value="${getComputedStyle(sample).color}">
        <label class="small-label mt-3 mb-1">גודל טקסט</label>
        <div class="flex items-center gap-2">
          <button type="button" id="textMinus" class="btn px-2 py-1">–</button>
          <input id="btnTextNumber" type="number" class="w-16 border p-1 text-center" value="${parseInt(getComputedStyle(sample).fontSize)}">
          <button type="button" id="textPlus" class="btn px-2 py-1">+</button>
        </div>
        <label class="small-label mt-3 mb-1">גודל כפתור</label>
        <div class="flex items-center gap-2">
          <button type="button" id="btnMinus" class="btn px-2 py-1">–</button>
          <input id="btnHeightNumber" type="number" class="w-16 border p-1 text-center" value="${parseInt(getComputedStyle(sample).height)}">
          <button type="button" id="btnPlus" class="btn px-2 py-1">+</button>
        </div>
        <label class="small-label mt-3 mb-1">פונט</label>
        <select id="btnFont" class="w-full border p-2">
          <option value="Arial">Arial</option>
          <option value="Tahoma">Tahoma</option>
          <option value="Rubik">Rubik</option>
          <option value="Verdana">Verdana</option>
        </select>
        <label class="small-label mt-3 mb-1">צורת כפתור</label>
        <select id="btnRadius" class="w-full border p-2">
          <option value="0px">מרובע</option>
          <option value="8px">פינות מעוגלות</option>
          <option value="20px">עיגול בינוני</option>
          <option value="9999px">עיגול מלא</option>
        </select>
      </div>`;

      document.getElementById('btnBg').addEventListener('input', e=>{
        targetButtons.forEach(b=>b.style.backgroundColor=e.target.value);
      });
      document.getElementById('btnColor').addEventListener('input', e=>{
        targetButtons.forEach(b=>b.style.color=e.target.value);
      });

      // גודל טקסט עם +/-
      const textInput = document.getElementById('btnTextNumber');
      document.getElementById('textMinus').addEventListener('click', ()=>{
        textInput.value = Math.max(1, parseInt(textInput.value)-1);
        targetButtons.forEach(b=>b.style.fontSize = textInput.value+'px');
      });
      document.getElementById('textPlus').addEventListener('click', ()=>{
        textInput.value = parseInt(textInput.value)+1;
        targetButtons.forEach(b=>b.style.fontSize = textInput.value+'px');
      });
      textInput.addEventListener('input', ()=>{
        let v=parseInt(textInput.value); if(isNaN(v)||v<1)v=1; textInput.value=v;
        targetButtons.forEach(b=>b.style.fontSize=v+'px');
      });

      // גודל כפתור עם +/-
      const heightInput = document.getElementById('btnHeightNumber');
      document.getElementById('btnMinus').addEventListener('click', ()=>{
        heightInput.value = Math.max(10, parseInt(heightInput.value)-1);
        targetButtons.forEach(b=>{
          b.style.height = heightInput.value+'px';
          b.style.padding = `0 ${Math.round(heightInput.value/2)}px`;
        });
      });
      document.getElementById('btnPlus').addEventListener('click', ()=>{
        heightInput.value = parseInt(heightInput.value)+1;
        targetButtons.forEach(b=>{
          b.style.height = heightInput.value+'px';
          b.style.padding = `0 ${Math.round(heightInput.value/2)}px`;
        });
      });
      heightInput.addEventListener('input', ()=>{
        let v=parseInt(heightInput.value); if(isNaN(v)||v<10)v=10; heightInput.value=v;
        targetButtons.forEach(b=>{
          b.style.height = v+'px';
          b.style.padding = `0 ${Math.round(v/2)}px`;
        });
      });

      document.getElementById('btnFont').addEventListener('change', e=>{
        targetButtons.forEach(b=>b.style.fontFamily=e.target.value);
      });
      document.getElementById('btnRadius').addEventListener('change', e=>{
        targetButtons.forEach(b=>b.style.borderRadius=e.target.value);
      });
    }
  }

  mainTitle.addEventListener('click', e=>renderEditor('title',e.currentTarget));
  subTitle.addEventListener('click', e=>renderEditor('subtitle',e.currentTarget));
  dayButtons.forEach(b=>b.addEventListener('click', e=>renderEditor('day', e.currentTarget)));
  slotButtons.forEach(b=>b.addEventListener('click', e=>renderEditor('slot', e.currentTarget)));

  // שמירה
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const daySample = dayButtons[0];
    const slotSample = slotButtons[0];
    const payload = {
      body_background_color: getComputedStyle(document.body).backgroundColor,
      heading_font_family: mainTitle.style.fontFamily,
      heading_font_size: mainTitle.style.fontSize,
      heading_color: getComputedStyle(mainTitle).color,
      heading_text: mainTitle.textContent,
      subheading_font_family: subTitle.style.fontFamily,
      subheading_font_size: subTitle.style.fontSize,
      subheading_color: getComputedStyle(subTitle).color,
      subheading_text: subTitle.textContent,
      day_button_shape: daySample.style.borderRadius,
      day_button_color: getComputedStyle(daySample).backgroundColor,
      day_button_text_size: daySample.style.fontSize,
      day_button_text_color: getComputedStyle(daySample).color,
      day_button_font_family: daySample.style.fontFamily,
      day_button_height: daySample.style.height,
      slot_button_shape: slotSample.style.borderRadius,
      slot_button_color: getComputedStyle(slotSample).backgroundColor,
      slot_button_text_size: slotSample.style.fontSize,
      slot_button_text_color: getComputedStyle(slotSample).color,
      slot_button_font_family: slotSample.style.fontFamily,
      slot_button_height: slotSample.style.height
    };
    try{
      const res = await fetch('/business_settings',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      alert(data.message || 'נשמר בהצלחה!');
    } catch(err){console.error(err); alert('שגיאה בשמירה');}
  });
});
</script>
</body>
</html>
