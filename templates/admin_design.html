<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>×¢×™×¦×•×‘ - ×ª×¦×•×’×” ××§×“×™××”</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      transition: background-color 0.2s; 
      background-color: #f5f5f5;
    }

    .btn { 
      transition: transform .12s ease, box-shadow .12s ease; 
      cursor: pointer; 
      padding: 6px 12px; 
      border-radius: 12px; 
      border: 1px solid #ccc; 
      background-color: #e0e0e0; 
      color: #000; 
      font-size: 14px; 
      font-family: Arial, sans-serif;
    }

    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
    }

    .selected-outline { 
      outline: 3px solid #f59e0b; 
      outline-offset: 3px; 
    }

    .small-label { 
      font-size: 0.9rem; 
      color: #555; 
    }
  </style>
</head>
<body>

<script>
  window.__DESIGN = {{ design_settings | tojson | safe }};
</script>

<div class="flex h-screen">

  <div class="w-3/4 p-6 overflow-auto">

    <div class="mb-6">
      <h1 id="mainTitle" class="text-2xl font-bold"></h1>
      <h2 id="subTitle" class="text-lg"></h2>
    </div>

    <div class="mb-6">
      <div class="grid grid-cols-7 gap-3" id="daysRow">
        {% for i in range(7) %}
          <button class="btn day-btn" data-type="day">DAY</button>
        {% endfor %}
      </div>
    </div>

    <div>
      <div class="grid grid-cols-5 gap-3" id="slotsGrid">
        {% for i in range(20) %}
          <button class="btn slot-btn" data-type="slot">HOUR</button>
        {% endfor %}
      </div>
    </div>
  </div>

  <aside id="sidePanel" class="w-1/4 bg-white p-6 border-l border-gray-300">
    <h3 class="text-lg font-semibold mb-4">××¤×©×¨×•×™×•×ª</h3>

    <div class="mb-4">
      <label class="block small-label mb-1">×¦×‘×¢ ×¨×§×¢ (×ª×¦×•×’×”)</label>
      <input id="pageBg" type="color" class="w-full h-10 p-0 border">
    </div>

    <div id="editorArea" class="text-gray-600">
      <p id="editorHint">×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ DAY ××• HOUR ××• ×¢×œ ×”×›×•×ª×¨×ª ×›×“×™ ×œ×¢×¨×•×š.</p>
    </div>

    <button id="saveBtn" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">ğŸ’¾ ×©××•×¨ (×œ×©×¨×ª)</button>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {

  const DS = window.__DESIGN || {};

  function rgbToHex(rgb){
    if (!rgb) return '#000000';
    if (rgb.startsWith('#')) return rgb;
    const m = rgb.match(/\d+/g);
    return '#' + m.slice(0,3).map(x=>{const h=parseInt(x).toString(16); return h.length===1?'0'+h:h}).join('');
  }

  // ×¦×‘×¢ ×¨×§×¢ ×’×•×£
  document.body.style.backgroundColor = DS.body_background_color || '#f5f5f5';

  const mainTitle = document.getElementById('mainTitle');
  const subTitle = document.getElementById('subTitle');

  mainTitle.textContent = DS.heading_text || '×›×•×ª×¨×ª';
  mainTitle.style.fontFamily = DS.heading_font_family || 'Arial, sans-serif';
  mainTitle.style.fontSize = DS.heading_font_size || '24px';
  mainTitle.style.color = DS.heading_color || '#000000';

  subTitle.textContent = DS.subheading_text || '×‘×—×¨×• ×ª×•×¨';
  subTitle.style.fontFamily = DS.subheading_font_family || 'Arial, sans-serif';
  subTitle.style.fontSize = DS.subheading_font_size || '16px';
  subTitle.style.color = DS.subheading_color || '#555555';

  function styleButtons(selector, color, textColor, radius, fontSize, fontFamily, padding){
    document.querySelectorAll(selector).forEach(btn=>{
      btn.style.backgroundColor = color;
      btn.style.color = textColor;
      btn.style.borderRadius = radius;
      btn.style.fontSize = fontSize;
      btn.style.fontFamily = fontFamily;
      btn.style.paddingTop = padding;
      btn.style.paddingBottom = padding;
      btn.style.border = '1px solid #ccc';
    });
  }

  styleButtons('.day-btn',
    DS.day_button_color || '#e0e0e0',
    DS.day_button_text_color || '#000000',
    DS.day_button_shape || '12px',
    DS.day_button_text_size || '14px',
    DS.day_button_font_family || 'Arial, sans-serif',
    DS.day_button_size || '6px'
  );

  styleButtons('.slot-btn',
    DS.slot_button_color || '#e0e0e0',
    DS.slot_button_text_color || '#000000',
    DS.slot_button_shape || '12px',
    DS.slot_button_text_size || '14px',
    DS.slot_button_font_family || 'Arial, sans-serif',
    DS.slot_button_size || '6px'
  );

  // ×¦×‘×¢ ×¨×§×¢ ×‘×ª×¦×•×’×ª input
  const pageBg = document.getElementById('pageBg');
  pageBg.value = rgbToHex(document.body.style.backgroundColor);
  pageBg.addEventListener('input', e=> document.body.style.backgroundColor = e.target.value);

  let currentType=null, currentTrigger=null;
  const editorArea = document.getElementById('editorArea');

  function clearSelectionOutline(){
    document.querySelectorAll('.day-btn,.slot-btn,#mainTitle,#subTitle').forEach(el=>el.classList.remove('selected-outline'));
  }

  function renderEditor(type, triggerEl=null){
    currentType=type;
    currentTrigger=triggerEl;
    clearSelectionOutline();
    if(triggerEl) triggerEl.classList.add('selected-outline');
    editorArea.innerHTML='';

    if(type==='day'||type==='slot'){
      const sample = type==='day'?document.querySelector('.day-btn'):document.querySelector('.slot-btn');
      const c = getComputedStyle(sample);

      editorArea.innerHTML=`<div>
        <p class="font-semibold mb-2">×¢×•×¨×š ${type==='day'?'DAY':'HOUR'}</p>
        <label class="block small-label mb-1">×¦×‘×¢ ×¨×§×¢</label>
        <input id="groupBg" type="color" class="w-full h-10 p-0 border" value="${rgbToHex(c.backgroundColor)}">
        <label class="block small-label mt-3 mb-1">×¦×‘×¢ ×˜×§×¡×˜</label>
        <input id="groupText" type="color" class="w-full h-10 p-0 border" value="${rgbToHex(c.color)}">
        <label class="block small-label mt-3 mb-1">×’×•×“×œ ×˜×§×¡×˜ (px)</label>
        <input id="groupFontSize" type="number" min="8" class="w-full border p-2" value="${parseInt(c.fontSize)}">
        <label class="block small-label mt-3 mb-1">×¤×•× ×˜</label>
        <select id="groupFontFamily" class="w-full border p-2">
          <option ${c.fontFamily.includes('Tahoma')?'selected':''}>Tahoma, sans-serif</option>
          <option ${c.fontFamily.includes('Arial')?'selected':''}>Arial, sans-serif</option>
          <option ${c.fontFamily.includes('Verdana')?'selected':''}>Verdana, sans-serif</option>
          <option ${c.fontFamily.includes('Georgia')?'selected':''}>Georgia, serif</option>
        </select>
        <label class="block small-label mt-3 mb-1">×’×•×‘×” ×¤× ×™××™ (padding px)</label>
        <input id="groupPadding" type="number" min="0" class="w-full border p-2" value="${parseInt(c.paddingTop)}">
        <label class="block small-label mt-3 mb-1">×¦×•×¨×ª ×›×¤×ª×•×¨ (border-radius)</label>
        <select id="groupShape" class="w-full border p-2">
          <option value="0px">××¨×•×‘×¢</option>
          <option value="6px">××¢×˜ ××¢×•×’×œ</option>
          <option value="12px" selected>××¢×•×’×œ</option>
          <option value="9999px">pill</option>
        </select>
        <p class="text-sm text-gray-500 mt-3">×”×©×™× ×•×™×™× ×™×—×•×œ×• ×¢×œ ×›×œ ×”×›×¤×ª×•×¨×™× ×‘×–××Ÿ ×××ª.</p>
      </div>`;

      const applyToGroup = ()=>{
        const bg = document.getElementById('groupBg').value;
        const text = document.getElementById('groupText').value;
        const fs = document.getElementById('groupFontSize').value+'px';
        const ff = document.getElementById('groupFontFamily').value;
        const pad = document.getElementById('groupPadding').value+'px';
        const rad = document.getElementById('groupShape').value;
        styleButtons(type==='day'?'.day-btn':'.slot-btn', bg, text, rad, fs, ff, pad);
      };

      ['groupBg','groupText','groupFontSize','groupFontFamily','groupPadding','groupShape'].forEach(id=>{
        document.getElementById(id).addEventListener('input', applyToGroup);
        document.getElementById(id).addEventListener('change', applyToGroup);
      });

    } else if(type==='title'||type==='subtitle'){
      const el = type==='title'?mainTitle:subTitle;
      const c = getComputedStyle(el);

      editorArea.innerHTML=`<div>
        <p class="font-semibold mb-2">×¢×•×¨×š ${type==='title'?'×›×•×ª×¨×ª':'×›×•×ª×¨×ª ××©× ×”'}</p>
        <label class="block small-label mb-1">×˜×§×¡×˜</label>
        <input id="titleText" type="text" class="w-full border p-2" value="${el.textContent}">
        <label class="block small-label mt-3 mb-1">×¦×‘×¢ ×˜×§×¡×˜</label>
        <input id="titleColor" type="color" class="w-full h-10 p-0 border" value="${rgbToHex(c.color)}">
        <label class="block small-label mt-3 mb-1">×’×•×“×œ ×˜×§×¡×˜ (px)</label>
        <input id="titleSize" type="number" class="w-full border p-2" value="${parseInt(c.fontSize)}">
        <label class="block small-label mt-3 mb-1">×¤×•× ×˜</label>
        <select id="titleFont" class="w-full border p-2">
          <option ${c.fontFamily.includes('Georgia')?'selected':''}>Georgia, serif</option>
          <option ${c.fontFamily.includes('Tahoma')?'selected':''}>Tahoma, sans-serif</option>
          <option ${c.fontFamily.includes('Verdana')?'selected':''}>Verdana, sans-serif</option>
          <option ${c.fontFamily.includes('Arial')?'selected':''}>Arial, sans-serif</option>
        </select>
      </div>`;

      document.getElementById('titleText').addEventListener('input', e=>el.textContent=e.target.value);
      document.getElementById('titleColor').addEventListener('input', e=>el.style.color=e.target.value);
      document.getElementById('titleSize').addEventListener('input', e=>el.style.fontSize=e.target.value+'px');
      document.getElementById('titleFont').addEventListener('change', e=>el.style.fontFamily=e.target.value);
    }
  }

  document.querySelectorAll('.day-btn').forEach(btn=>btn.addEventListener('click', e=>renderEditor('day',e.currentTarget)));
  document.querySelectorAll('.slot-btn').forEach(btn=>btn.addEventListener('click', e=>renderEditor('slot',e.currentTarget)));
  mainTitle.addEventListener('click', e=>renderEditor('title',e.currentTarget));
  subTitle.addEventListener('click', e=>renderEditor('subtitle',e.currentTarget));

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const daySample=document.querySelector('.day-btn');
    const slotSample=document.querySelector('.slot-btn');

    const payload = {
      body_background_color: document.body.style.backgroundColor,
      heading_font_family: mainTitle.style.fontFamily,
      heading_font_size: mainTitle.style.fontSize,
      heading_color: mainTitle.style.color,
      heading_text: mainTitle.textContent,
      subheading_font_family: subTitle.style.fontFamily,
      subheading_font_size: subTitle.style.fontSize,
      subheading_color: subTitle.style.color,
      subheading_text: subTitle.textContent,
      day_button_shape: daySample.style.borderRadius,
      day_button_color: daySample.style.backgroundColor,
      day_button_size: daySample.style.paddingTop,
      day_button_text_size: daySample.style.fontSize,
      day_button_text_color: daySample.style.color,
      day_button_font_family: daySample.style.fontFamily,
      slot_button_shape: slotSample.style.borderRadius,
      slot_button_color: slotSample.style.backgroundColor,
      slot_button_size: slotSample.style.paddingTop,
      slot_button_text_size: slotSample.style.fontSize,
      slot_button_text_color: slotSample.style.color,
      slot_button_font_family: slotSample.style.fontFamily
    };

    try{
      const res = await fetch('/business_settings',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || '×©×’×™××” ×‘×©×¨×ª');
      alert(data.message || '× ×©××¨ ×‘×”×¦×œ×—×”!');
    } catch(err){
      console.error(err);
      alert('×©×’×™××” ×‘×©××™×¨×” â€” ×‘×“×•×§ ××ª ×”×©×¨×ª (console).');
    }
  });

});
</script>
</body>
</html>
