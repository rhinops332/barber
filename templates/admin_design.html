<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Design Preview</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
<style>
  body { font-family: Arial, sans-serif; background: #f7f9fc; padding: 20px; }
  #container { display: flex; gap: 20px; }
  #controls { width: 250px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  #canvas { flex: 1; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .draggable { display: inline-flex; align-items:center; justify-content:center; padding:10px; margin:5px; color:white; font-weight:bold; cursor:pointer; transition:0.2s; }
  .selected { outline: 3px solid #ff9800; transform: scale(1.05); }
  .day-btn { width: 100%; text-align:center; }
  .slot-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:5px; margin-top:5px; }
</style>
</head>
<body>

<h1 id="mainTitle">Heading</h1>
<h2 id="subTitle">Subheading</h2>

<div id="container">
  <!-- Controls Panel -->
  <div id="controls">
    <h3 class="mb-2 font-bold">בחר אלמנט</h3>
    <select id="elementSelect">
      <option value="">---</option>
      <option value="day">Day</option>
      <option value="slot">Hour</option>
      <option value="title">Heading</option>
      <option value="subtitle">Subheading</option>
    </select>

    <label class="block mt-3">צבע רקע:</label>
    <div id="bgPicker"></div>

    <label class="block mt-3">צבע טקסט:</label>
    <div id="textPicker"></div>

    <label class="block mt-3">צורת כפתור:</label>
    <select id="shapeSelect">
      <option value="8px">Rounded</option>
      <option value="50px">Pill</option>
      <option value="0px">Square</option>
    </select>

    <button id="saveLayout" class="mt-6 w-full bg-green-600 text-white py-2 rounded-lg shadow hover:bg-green-700">💾 שמור עיצוב</button>
  </div>

  <!-- Canvas Preview -->
  <div id="canvas">
    <div id="daysContainer">
      <!-- 7 Days -->
      <div class="draggable day-btn" data-type="day">DAY 1</div>
      <div class="draggable day-btn" data-type="day">DAY 2</div>
      <div class="draggable day-btn" data-type="day">DAY 3</div>
      <div class="draggable day-btn" data-type="day">DAY 4</div>
      <div class="draggable day-btn" data-type="day">DAY 5</div>
      <div class="draggable day-btn" data-type="day">DAY 6</div>
      <div class="draggable day-btn" data-type="day">DAY 7</div>
    </div>

    <!-- Slots -->
    <div id="slotsContainer">
      <div class="slot-grid">
        <!-- 20 Hours -->
        <div class="draggable slot-btn" data-type="slot">HOUR 1</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 2</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 3</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 4</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 5</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 6</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 7</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 8</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 9</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 10</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 11</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 12</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 13</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 14</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 15</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 16</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 17</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 18</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 19</div>
        <div class="draggable slot-btn" data-type="slot">HOUR 20</div>
      </div>
    </div>
  </div>
</div>

<script>
let selectedType = null;

// Pickr instances
const bgPicker = Pickr.create({
  el: '#bgPicker',
  theme: 'classic',
  default: '#3498db',
  components: { preview:true, interaction:{hex:true,input:true} }
});
const textPicker = Pickr.create({
  el: '#textPicker',
  theme: 'classic',
  default: '#ffffff',
  components: { preview:true, interaction:{hex:true,input:true} }
});

// אלמנט נבחר
function applyLiveChanges() {
  if(!selectedType) return;
  if(selectedType === "day"){
    document.querySelectorAll('.day-btn').forEach(el=>{
      el.style.backgroundColor = bgPicker.getColor().toHEXA().toString();
      el.style.color = textPicker.getColor().toHEXA().toString();
      el.style.borderRadius = document.getElementById('shapeSelect').value;
    });
  }
  if(selectedType === "slot"){
    document.querySelectorAll('.slot-btn').forEach(el=>{
      el.style.backgroundColor = bgPicker.getColor().toHEXA().toString();
      el.style.borderRadius = document.getElementById('shapeSelect').value;
    });
  }
  if(selectedType === "title"){
    document.getElementById('mainTitle').style.backgroundColor = bgPicker.getColor().toHEXA().toString();
  }
  if(selectedType === "subtitle"){
    document.getElementById('subTitle').style.backgroundColor = bgPicker.getColor().toHEXA().toString();
  }
}

// בחירת אלמנט
document.getElementById('elementSelect').addEventListener('change', e=>{
  selectedType = e.target.value;
  applyLiveChanges();
});

// שינוי צבעים live
bgPicker.on('change', applyLiveChanges);
textPicker.on('change', applyLiveChanges);

// שינוי צורת כפתור live
document.getElementById('shapeSelect').addEventListener('change', applyLiveChanges);

// שמירה למסד
document.getElementById('saveLayout').addEventListener('click', async ()=>{
  const layout = {
    mainTitle: document.getElementById('mainTitle').textContent,
    subTitle: document.getElementById('subTitle').textContent,
    days: [],
    slots: []
  };
  document.querySelectorAll('.day-btn').forEach(el=>{
    layout.days.push({
      text: el.textContent,
      bgColor: el.style.backgroundColor,
      textColor: el.style.color,
      borderRadius: el.style.borderRadius
    });
  });
  document.querySelectorAll('.slot-btn').forEach(el=>{
    layout.slots.push({
      text: el.textContent,
      bgColor: el.style.backgroundColor,
      borderRadius: el.style.borderRadius
    });
  });

  const res = await fetch('/business_settings', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({layout_json: layout})
  });
  const data = await res.json();
  alert(data.message || "נשמר בהצלחה!");
});
</script>

</body>
</html>
