<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>×¢×™×¦×•×‘ - ×ª×¦×•×’×” ××§×“×™××”</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .btn { transition: transform .12s ease, box-shadow .12s ease; cursor:pointer; }
    .btn:hover { transform: translateY(-2px); }
    .selected-outline { outline: 3px solid #f59e0b; outline-offset: 3px; }
  </style>
</head>
<body class="bg-gray-100 h-screen">

  <div class="flex h-full">

    <!-- ×©×××œ: ×ª×¦×•×’×” -->
    <div class="w-3/4 p-6 overflow-auto">
      <!-- ×›×•×ª×¨×•×ª (× ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘-Jinja: {{ heading_text }} ×•×›×•') -->
      <div class="mb-6">
        <h1 id="mainTitle" class="text-2xl font-bold">×›×•×ª×¨×ª</h1>
        <h2 id="subTitle" class="text-lg text-gray-600">×›×•×ª×¨×ª ××©× ×”</h2>
      </div>

      <!-- DAYS: 7 ×›×¤×ª×•×¨×™×, ×›×•×œ× ××¦×™×’×™× "DAY" -->
      <div class="mb-6">
        <div class="grid grid-cols-7 gap-3">
          <!-- × ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘-Jinja ×›×“×™ ×œ×”×©×ª××© ×‘×¢×¨×›×™× ××”-DB -->
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
          <button class="btn day-btn px-3 py-3 text-white" data-type="day">DAY</button>
        </div>
      </div>

      <!-- SLOTS: 20 ×›×¤×ª×•×¨×™× - 5 ×‘×›×œ ×©×•×¨×”, ×›×•×œ× ××¦×™×’×™× "HOUR" -->
      <div>
        <div class="grid grid-cols-5 gap-3">
          <!-- 20 ×›×¤×ª×•×¨×™× -->
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>

          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>

          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>

          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
          <button class="btn slot-btn px-3 py-2 text-white" data-type="slot">HOUR</button>
        </div>
      </div>
    </div>

    <!-- ×™××™×Ÿ: ×¤×× ×œ ×§×‘×•×¢ -->
    <aside id="sidePanel" class="w-1/4 bg-white p-6 border-l border-gray-300">
      <h3 class="text-lg font-semibold mb-4">××¤×©×¨×•×™×•×ª</h3>

      <!-- ×ª××™×“: ×©×™× ×•×™ ×¦×‘×¢ ×¨×§×¢ ×©×œ ×”×“×£ (×–××™×Ÿ ×’× ×›×©×œ× × ×‘×—×¨ ×›×œ×•×) -->
      <div class="mb-4">
        <label class="block text-sm mb-1">×¦×‘×¢ ×¨×§×¢ (×ª×¦×•×’×”)</label>
        <input id="pageBg" type="color" class="w-full h-10 p-0 border" value="#f3f4f6">
      </div>

      <!-- ×ª×•×›×Ÿ ×©××©×ª× ×” ×œ×¤×™ ×‘×—×™×¨×”: ×‘××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ ××™×Ÿ ×¤×¨×˜×™× × ×•×¡×¤×™× -->
      <div id="editorArea" class="text-gray-600">
        <p id="editorHint">×‘×—×¨ ×›×¤×ª×•×¨ DAY ××• HOUR ×›×“×™ ×œ×¢×¨×•×š â€” ×× ×œ× × ×‘×—×¨ ×›×œ×•×, ×¨×§ ×¦×‘×¢ ×”×¨×§×¢ ×–××™×Ÿ.</p>
      </div>

      <button id="saveBtn" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">ğŸ’¾ ×©××•×¨ (×©×•×œ×— ×œ×©×¨×ª)</button>
    </aside>
  </div>

<script>
/* --- ×¢×™×§×¨×™ --- */
const pageBg = document.getElementById('pageBg');
const editorArea = document.getElementById('editorArea');
const editorHint = document.getElementById('editorHint');
const saveBtn = document.getElementById('saveBtn');

let selectedGroup = null; // "day" | "slot" | null
let selectedTriggerBtn = null; // ×”×›×¤×ª×•×¨ ×©× ×œ×—×¥ (×œ×”×¦×’×” ×•-outline)

/* ×‘×¨×™×¨×•×ª ××—×“×œ (× ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘-Jinja inline values ××”-DB) */
const defaults = {
  dayBg: "{{ day_button_color if false else '#3498db' }}",
  dayText: "{{ day_button_text_color if false else '#ffffff' }}",
  dayRadius: "{{ day_button_shape if false else '12px' }}",
  slotBg: "{{ slot_button_color if false else '#2ecc71' }}",
  slotText: "{{ slot_button_text_color if false else '#ffffff' }}",
  slotRadius: "{{ slot_button_shape if false else '8px' }}"
};

/* ××ª×—×•×œ ×›×¤×ª×•×¨×™× ×¢× ×¢×¨×›×™× ×‘×¨×™×¨×ª ××—×“×œ (×× ×”×‘× ×™×” ×‘-Jinja ×›×‘×¨ ×©×™× ×ª×” - ×™×©××¨) */
document.querySelectorAll('.day-btn').forEach(btn => {
  if (!btn.style.backgroundColor) btn.style.backgroundColor = defaults.dayBg;
  if (!btn.style.color) btn.style.color = defaults.dayText;
  if (!btn.style.borderRadius) btn.style.borderRadius = defaults.dayRadius;
});
document.querySelectorAll('.slot-btn').forEach(btn => {
  if (!btn.style.backgroundColor) btn.style.backgroundColor = defaults.slotBg;
  if (!btn.style.color) btn.style.color = defaults.slotText;
  if (!btn.style.borderRadius) btn.style.borderRadius = defaults.slotRadius;
});

/* ×©×™× ×•×™ ×¦×‘×¢ ×¨×§×¢ ×©×œ ×”×“×£ - ×ª××™×“ ×–××™×Ÿ */
pageBg.addEventListener('input', (e) => {
  document.body.style.backgroundColor = e.target.value;
});

/* ×”××¨×” ×Ö¾rgb(...) ×œÖ¾hex */
function rgbToHex(rgb) {
  if (!rgb) return '#000000';
  // ×× ×›×‘×¨ HEX
  if (rgb.startsWith('#')) return rgb;
  const m = rgb.match(/\d+/g);
  if (!m) return '#000000';
  return '#' + m.slice(0,3).map(x => {
    const h = parseInt(x).toString(16);
    return h.length === 1 ? '0' + h : h;
  }).join('');
}

/* ×”×—×œ×ª ×¡×’× ×•×Ÿ ×¢×œ ×§×‘×•×¦×” (day/slot) */
function applyToGroup(type, styles) {
  const selector = type === 'day' ? '.day-btn' : '.slot-btn';
  document.querySelectorAll(selector).forEach(el => {
    if (styles.backgroundColor !== undefined) el.style.backgroundColor = styles.backgroundColor;
    if (styles.color !== undefined) el.style.color = styles.color;
    if (styles.borderRadius !== undefined) el.style.borderRadius = styles.borderRadius;
  });
}

/* ×‘×•× ×” ××ª ×”×¤×× ×œ ×‘×”×ª×× ×œ×¡×•×’ ×”× ×‘×—×¨ */
function renderEditorFor(type, triggerBtn) {
  selectedGroup = type;
  selectedTriggerBtn = triggerBtn;

  // ×”×¡×™×¨ ×¡×’× ×•×Ÿ ×‘×—×™×¨×” ××›×œ ×”×›×¤×ª×•×¨×™×, ×•× ×ª×Ÿ outline ×œ×›×¤×ª×•×¨ ×©× ×œ×—×¥
  document.querySelectorAll('.day-btn, .slot-btn').forEach(b => b.classList.remove('selected-outline'));
  if (triggerBtn) triggerBtn.classList.add('selected-outline');

  // × ×©××£ ×œ×¢×¨×›×™ ×”×§×‘×•×¦×” ××ª×•×š ×”×›×¤×ª×•×¨ ×©× ×œ×—×¥ (××—×œ×™×£ ×¢×œ ×™×“×™ getComputedStyle)
  const sample = triggerBtn || document.querySelector(type === 'day' ? '.day-btn' : '.slot-btn');
  const computed = window.getComputedStyle(sample);

  const currentBg = rgbToHex(computed.backgroundColor);
  const currentColor = rgbToHex(computed.color);
  const currentRadius = computed.borderRadius || '12px';

  // ×‘× ×” HTML ××ª××™×: DAY ×•-SLOT ××§×‘×œ×™× ×’× ×¦×‘×¢ ×˜×§×¡×˜; × ×™×ª×Ÿ ×œ×©× ×•×ª ×¦×•×¨×” (border-radius)
  editorArea.innerHTML = `
    <div>
      <p class="font-semibold mb-2">×¢×•×¨×š ${type === 'day' ? 'DAY' : 'HOUR'}</p>

      <label class="block text-sm mb-1">×¦×‘×¢ ×¨×§×¢</label>
      <input id="groupBg" type="color" class="w-full h-10 p-0 border" value="${currentBg}">

      <label class="block text-sm mt-3 mb-1">×¦×‘×¢ ×˜×§×¡×˜</label>
      <input id="groupText" type="color" class="w-full h-10 p-0 border" value="${currentColor}">

      <label class="block text-sm mt-3 mb-1">×¦×•×¨×ª ×›×¤×ª×•×¨ (border-radius)</label>
      <select id="groupShape" class="w-full border p-2">
        <option value="0px"${currentRadius==='0px' ? ' selected' : ''}>××¨×•×‘×¢ (0px)</option>
        <option value="6px"${currentRadius==='6px' ? ' selected' : ''}>××¢×˜ ××¢×•×’×œ (6px)</option>
        <option value="12px"${currentRadius==='12px' ? ' selected' : ''}>××¢×•×’×œ (12px)</option>
        <option value="9999px"${(currentRadius.includes('9999')|| currentRadius.includes('50%')) ? ' selected' : ''}>×¤××“×™× ×’ (pill)</option>
      </select>

      <p class="text-sm text-gray-500 mt-3">×”×©×™× ×•×™×™× ×™×—×•×œ×• ×¢×œ ×›×œ ×”×›×¤×ª×•×¨×™× ××”×§×‘×•×¦×” ×‘×–××Ÿ ×××ª. ×”×©××™×¨×” ×ª×¢×“×›×Ÿ ××ª ×”×©×¨×ª.</p>
    </div>
  `;

  // ×××–×™× ×™× ×œ×©×™× ×•×™×™×
  const groupBg = document.getElementById('groupBg');
  const groupText = document.getElementById('groupText');
  const groupShape = document.getElementById('groupShape');

  groupBg.addEventListener('input', () => {
    applyToGroup(type, { backgroundColor: groupBg.value });
  });
  groupText.addEventListener('input', () => {
    applyToGroup(type, { color: groupText.value });
  });
  groupShape.addEventListener('change', () => {
    applyToGroup(type, { borderRadius: groupShape.value });
  });
}

/* ×××–×™× ×™× ×œ×›×¤×ª×•×¨×™×: ×œ×—×™×¦×” ×¢×œ ×›×œ ×›×¤×ª×•×¨ DAY/ SLOT ×ª×¤×ª×— ×¢×•×¨×š - ××š ×©×™× ×•×™ ×™×—×•×œ ×¢×œ ×›×œ ×”×§×‘×•×¦×” */
document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    renderEditorFor('day', e.currentTarget);
  });
});
document.querySelectorAll('.slot-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    renderEditorFor('slot', e.currentTarget);
  });
});

/* ×©××™×¨×”: ××•×¡×£ ×¡×’× ×•×Ÿ × ×•×›×—×™ ×•××‘×¦×¢ POST ×œ×©×¨×ª (endpoint: /business_settings) */
saveBtn.addEventListener('click', async () => {
  // ×§×— ×¡×’× ×•×Ÿ ××”×›×¤×ª×•×¨ ×”×¨××©×•×Ÿ ×©×œ ×›×œ ×§×‘×•×¦×” ×›×™×™×¦×•×’
  const daySample = document.querySelector('.day-btn');
  const slotSample = document.querySelector('.slot-btn');
  const dayStyle = window.getComputedStyle(daySample);
  const slotStyle = window.getComputedStyle(slotSample);

  const payload = {
    layout_json: {
      page_background: rgbToHex(getComputedStyle(document.body).backgroundColor),
      day: {
        background: rgbToHex(dayStyle.backgroundColor),
        text_color: rgbToHex(dayStyle.color),
        border_radius: daySample.style.borderRadius || dayStyle.borderRadius
      },
      slot: {
        background: rgbToHex(slotStyle.backgroundColor),
        text_color: rgbToHex(slotStyle.color),
        border_radius: slotSample.style.borderRadius || slotStyle.borderRadius
      }
    }
  };

  try {
    const res = await fetch('/business_settings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    alert(data.message || '× ×©××¨ ×‘×”×¦×œ×—×”!');
  } catch (err) {
    console.error(err);
    alert('×©×’×™××” ×‘×©××™×¨×” â€” ×‘×“×•×§ ××ª ×”×©×¨×ª ×‘×§×¦×” ×”Ö¾API');
  }
});
</script>
</body>
</html>
