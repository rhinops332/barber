<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ניהול שינויים חד-פעמיים - HairBoss</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Alef&display=swap');
    body {
      font-family: 'Alef', Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
      color: #222;
      direction: rtl;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      user-select: none;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      box-shadow: 0 0 15px rgb(0 0 0 / 0.07);
      border-radius: 10px;
      padding: 20px;
    }
    .dates-container {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .date-btn {
      flex: 0 0 auto;
      padding: 12px 18px;
      background: #eee;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.25s ease;
      border: 2px solid transparent;
      min-width: 110px;
      text-align: center;
    }
    .date-btn.active {
      background: #4a90e2;
      color: white;
      border-color: #3b7dc4;
      box-shadow: 0 4px 10px rgb(74 144 226 / 0.4);
    }
    .date-btn:hover {
      background: #d0e2ff;
      border-color: #8ab4f8;
    }

    .slots-container {
      margin-top: 10px;
    }

    .slots-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      user-select: none;
    }

    .slots-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.2rem;
      color: #4a90e2;
    }

    .btn-day-toggle {
      cursor: pointer;
      background: #f04e3e;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      transition: background-color 0.3s ease;
    }
    .btn-day-toggle.enabled {
      background: #32b852;
    }
    .btn-day-toggle:hover {
      opacity: 0.9;
    }

    .slots-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }

    .slot-item {
      background: #f2f6fb;
      border-radius: 10px;
      box-shadow: 0 0 8px rgb(74 144 226 / 0.15);
      padding: 12px 14px;
      flex: 0 0 120px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.25s ease;
      cursor: default;
    }
    .slot-item.available {
      background: #d6f0d6;
      box-shadow: 0 0 10px rgb(50 184 82 / 0.4);
      color: #317731;
    }
    .slot-item.unavailable {
      background: #f8d7da;
      color: #8a2027;
      box-shadow: 0 0 10px rgb(240 78 62 / 0.4);
      opacity: 0.7;
    }

    .slot-actions {
      display: flex;
      gap: 6px;
    }
    .slot-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    .slot-btn:hover {
      background: #4a90e2;
      color: white;
    }
    .slot-btn.delete {
      color: #f04e3e;
    }
    .slot-btn.toggle {
      color: #32b852;
    }
    .slot-btn.edit {
      color: #333;
    }

    .add-slot-container {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .add-slot-input {
      flex-grow: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.8px solid #ccc;
      font-size: 1rem;
      font-weight: 600;
      font-family: monospace;
      text-align: center;
    }
    .btn-add-slot {
      cursor: pointer;
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 18px;
      font-weight: 700;
      border-radius: 8px;
      transition: background-color 0.25s ease;
    }
    .btn-add-slot:hover {
      background: #3b7dc4;
    }

    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      user-select: none;
      display: none;
    }
    .message.success {
      background: #d6f0d6;
      color: #317731;
      box-shadow: 0 0 10px rgb(50 184 82 / 0.4);
    }
    .message.error {
      background: #f8d7da;
      color: #8a2027;
      box-shadow: 0 0 10px rgb(240 78 62 / 0.4);
    }

    /* Modal Edit Slot */
    .modal {
      position: fixed;
      inset: 0;
      background: rgb(0 0 0 / 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 999;
    }
    .modal.active {
      visibility: visible;
      opacity: 1;
    }
    .modal-content {
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 15px rgb(0 0 0 / 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-content label {
      font-weight: 700;
      color: #4a90e2;
    }
    .modal-content input[type="text"] {
      font-family: monospace;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1.8px solid #ccc;
      font-size: 1rem;
      text-align: center;
    }
    .modal-content .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }
    .btn-modal-save, .btn-modal-cancel {
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.25s ease;
    }
    .btn-modal-save {
      background: #32b852;
      color: white;
    }
    .btn-modal-save:hover {
      background: #299b43;
    }
    .btn-modal-cancel {
      background: #f04e3e;
      color: white;
    }
    .btn-modal-cancel:hover {
      background: #c23d32;
    }

    /* Loader Surprise Button */
    .btn-refresh {
      margin-left: 15px;
      cursor: pointer;
      background: #32b852;
      border: none;
      color: white;
      font-weight: 700;
      padding: 10px 18px;
      border-radius: 10px;
      transition: background-color 0.3s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .btn-refresh:hover {
      background: #299b43;
    }
    .btn-refresh.loading::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 10px;
      border: 3px solid white;
      border-top-color: transparent;
      animation: spin 1.2s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <header>
    ניהול שינויים חד-פעמיים
  </header>
  <main>
    <div class="dates-container" id="datesContainer" aria-label="בחירת תאריכים בשבוע הקרוב">
      <!-- כפתורי תאריכים ייווצרו דינמית -->
    </div>

    <section class="slots-container" id="slotsContainer" aria-live="polite" aria-atomic="true" aria-relevant="additions removals">
      <!-- שעות לכל תאריך -->
    </section>

    <div class="message" id="messageBox" role="alert"></div>
  </main>

  <!-- מודל עריכת שעה -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="modal-content">
      <h3 id="modalTitle">עריכת שעה</h3>
      <label for="editTimeInput">זמן (לדוגמה: 14:00):</label>
      <input type="text" id="editTimeInput" pattern="^([01]\d|2[0-3]):([0-5]\d)$" title="פורמט שעה HH:MM, לדוגמה 14:30" />
      <div class="modal-actions">
        <button class="btn-modal-save" id="modalSaveBtn">שמור</button>
        <button class="btn-modal-cancel" id="modalCancelBtn">בטל</button>
      </div>
    </div>
  </div>

  <script>
    // משתנים גלובליים
    const datesContainer = document.getElementById('datesContainer');
    const slotsContainer = document.getElementById('slotsContainer');
    const messageBox = document.getElementById('messageBox');
    const editModal = document.getElementById('editModal');
    const editTimeInput = document.getElementById('editTimeInput');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    // אחסון נתונים מקומי
    let overrides = {};
    let baseSchedule = {};
    let selectedDate = null;

    // נתוני יום שנבחר לעריכה (slot)
    let slotBeingEdited = null;

    // פונקציה להצגת הודעה (סוגים: success | error)
    function showMessage(text, type = "success") {
      messageBox.textContent = text;
      messageBox.className = 'message ' + type;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.opacity = '1';
      }, 10);
      setTimeout(() => {
        messageBox.style.opacity = '0';
        setTimeout(() => {
          messageBox.style.display = 'none';
        }, 400);
      }, 4000);
    }

    // טען נתונים מהשרת
    async function loadData() {
      try {
        // נתוני overrides + שגרה בסיסית מגיעים מהשרת בצורת משתנים מוטמעים ב-HTML
        // אך כאן נבקש JSON מהשרת בAPI או בעמוד (אפשר להחליף בהתאם לצורך)
        // למשל: fetch('/api/overrides')
        // כאן נשתמש במידע מוטמע — יש להוסיף אותם ב-render_template

        // במקרה שהשרת שולח את המידע בקובץ JS - כאן נממש דוגמה סטטית
        // בפועל, החלף את השורות האלו לנתונים שמגיעים מ-flask ב-Jinja:
        // window.overridesData ו-window.baseScheduleData

        // לדוגמה, אם אתה מעביר ב-jinja:
        // <script>window.overridesData = {{ overrides|tojson }}; window.baseScheduleData = {{ base_schedule|tojson }};</script>

        overrides = window.overridesData || {};
        baseSchedule = window.baseScheduleData || {};

        // צור כפתורי תאריכים (7 ימים)
        createDateButtons();
      } catch (err) {
        showMessage("שגיאה בטעינת הנתונים: " + err.message, "error");
      }
    }

    // צור כפתורי תאריכים לשבוע הקרוב
    function createDateButtons() {
      datesContainer.innerHTML = '';
      const today = new Date();

      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);

        const dateStr = date.toISOString().slice(0, 10);
        const dayName = getDayName(date.getDay());
        const label = `${dayName} ${dateStr}`;

        const btn = document.createElement('button');
        btn.textContent = label;
        btn.classList.add('date-btn');
        btn.dataset.date = dateStr;
        btn.setAttribute('aria-pressed', 'false');
        btn.title = 'הצג שעות ליום זה';

        btn.addEventListener('click', () => {
          // בטל בחירת כל הכפתורים
          document.querySelectorAll('.date-btn').forEach(b => {
            b.classList.remove('active');
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');
          selectedDate = dateStr;
          renderSlotsForDate(dateStr);
        });

        datesContainer.appendChild(btn);

        // בחר את היום הראשון כברירת מחדל
        if (i === 0) {
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');
          selectedDate = dateStr;
          renderSlotsForDate(dateStr);
        }
      }
    }

    // המרה של מספר יום באנגלית ליום בעברית (0=ראשון)
    function getDayName(jsDayIndex) {
      // jsDayIndex: ראשון=0, שני=1 ... שבת=6
      const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
      return days[jsDayIndex] || '';
    }

    // הצגת שעות עבור תאריך מסוים
    function renderSlotsForDate(dateStr) {
      slotsContainer.innerHTML = '';

      // כותרת עם כפתור יום כבוי/פעיל
      const header = document.createElement('div');
      header.classList.add('slots-header');

      const h2 = document.createElement('h2');
      h2.textContent = `תאריכי ${dateStr}`;
      header.appendChild(h2);

      const btnToggleDay = document.createElement('button');
      btnToggleDay.classList.add('btn-day-toggle');
      btnToggleDay.textContent = 'כבה יום';
      btnToggleDay.title = 'כיבוי או הפעלה של כל היום';

      // בדיקת מצב היום - אם כל השעות כבויות
      const dayOverride = overrides[dateStr];
      const allTimes = getAllTimesForDate(dateStr);
      const dayDisabled = dayOverride && dayOverride.remove && dayOverride.remove.includes("__all__");
      if (dayDisabled) {
        btnToggleDay.textContent = 'הפעל יום';
        btnToggleDay.classList.add('enabled');
      }

      btnToggleDay.addEventListener('click', async () => {
        btnToggleDay.disabled = true;
        btnToggleDay.classList.add('loading');

        try {
          await fetch('/overrides_toggle_day', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: dateStr, enabled: dayDisabled})
          });
          // רענון נתונים
          await fetchOverrides();
          renderSlotsForDate(dateStr);
          showMessage(dayDisabled ? 'היום הופעל בהצלחה' : 'היום כובה בהצלחה', 'success');
        } catch (err) {
          showMessage('שגיאה בכיבוי/הפעלה של היום: ' + err.message, 'error');
        } finally {
          btnToggleDay.disabled = false;
          btnToggleDay.classList.remove('loading');
        }
      });

      header.appendChild(btnToggleDay);
      slotsContainer.appendChild(header);

      // רשימת השעות
      const slotsList = document.createElement('div');
      slotsList.classList.add('slots-list');
      slotsContainer.appendChild(slotsList);

      // טען רשימת שעות עם מצב כל שעה - זמינה, לא זמינה, או לא קיים

      // כל הזמנים לשעה (מ-08:00 עד 20:00 חצי שעה)
      const times = getAllTimesForDate(dateStr);

      // כל השעות זמינות מהשגרה (baseSchedule), מופרעות ע"י overrides (אולי כיבוי או הוספה)
      for (const time of times) {
        const slotElem = createSlotElement(dateStr, time);
        slotsList.appendChild(slotElem);
      }

      // אזור להוספת שעה חדשה
      const addContainer = document.createElement('div');
      addContainer.classList.add('add-slot-container');

      const inputAdd = document.createElement('input');
      inputAdd.type = 'text';
      inputAdd.placeholder = 'הוסף שעה חדשה (לדוגמה: 15:30)';
      inputAdd.classList.add('add-slot-input');
      inputAdd.pattern = "^([01]\\d|2[0-3]):([0-5]\\d)$";
      inputAdd.title = "פורמט שעה HH:MM, לדוגמה 14:30";

      const btnAdd = document.createElement('button');
      btnAdd.textContent = 'הוסף';
      btnAdd.classList.add('btn-add-slot');
      btnAdd.addEventListener('click', async () => {
        const newTime = inputAdd.value.trim();
        if (!newTime.match(/^([01]\d|2[0-3]):([0-5]\d)$/)) {
          showMessage('פורמט הזמן לא תקין. השתמש HH:MM', 'error');
          return;
        }
        btnAdd.disabled = true;
        try {
          await fetch('/overrides_add_slot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: selectedDate, time: newTime})
          });
          await fetchOverrides();
          renderSlotsForDate(selectedDate);
          inputAdd.value = '';
          showMessage('השעה נוספה בהצלחה', 'success');
        } catch (err) {
          showMessage('שגיאה בהוספת שעה: ' + err.message, 'error');
        } finally {
          btnAdd.disabled = false;
        }
      });

      addContainer.appendChild(inputAdd);
      addContainer.appendChild(btnAdd);
      slotsContainer.appendChild(addContainer);
    }

    // צור אלמנט שעה עם כפתורי פעולה
    function createSlotElement(dateStr, time) {
      const slotElem = document.createElement('div');
      slotElem.classList.add('slot-item');

      // בדוק אם השעה זמינה (לא כבויה) לפי overrides
      const dayOverride = overrides[dateStr];
      let isRemoved = false;
      if (dayOverride && dayOverride.remove) {
        isRemoved = dayOverride.remove.includes(time) || dayOverride.remove.includes("__all__");
      }
      if (isRemoved) {
        slotElem.classList.add('unavailable');
      } else {
        slotElem.classList.add('available');
      }
      slotElem.textContent = time;

      // פעולות
      const actions = document.createElement('div');
      actions.classList.add('slot-actions');

      // כפתור toggle (הפוך זמינות)
      const btnToggle = document.createElement('button');
      btnToggle.classList.add('slot-btn', 'toggle');
      btnToggle.title = isRemoved ? 'הפוך לזמין' : 'הפוך ללא זמין';
      btnToggle.innerHTML = isRemoved ? '✔️' : '❌';
      btnToggle.addEventListener('click', async (e) => {
        e.stopPropagation();
        btnToggle.disabled = true;
        try {
          await fetch('/overrides_toggle_slot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: dateStr, time: time})
          });
          await fetchOverrides();
          renderSlotsForDate(dateStr);
          showMessage(isRemoved ? 'השעה הופעלה' : 'השעה כובה', 'success');
        } catch (err) {
          showMessage('שגיאה בשינוי שעה: ' + err.message, 'error');
        } finally {
          btnToggle.disabled = false;
        }
      });
      actions.appendChild(btnToggle);

      // כפתור עריכה
      const btnEdit = document.createElement('button');
      btnEdit.classList.add('slot-btn', 'edit');
      btnEdit.title = 'ערוך שעה';
      btnEdit.textContent = '✏️';
      btnEdit.addEventListener('click', (e) => {
        e.stopPropagation();
        openEditModal(dateStr, time);
      });
      actions.appendChild(btnEdit);

      // כפתור מחיקה
      const btnDelete = document.createElement('button');
      btnDelete.classList.add('slot-btn', 'delete');
      btnDelete.title = 'מחק שעה';
      btnDelete.textContent = '🗑️';
      btnDelete.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!confirm(`בטוח שברצונך למחוק את השעה ${time} ב-${dateStr}?`)) return;
        try {
          await fetch('/overrides_delete_slot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: dateStr, time: time})
          });
          await fetchOverrides();
          renderSlotsForDate(dateStr);
          showMessage('השעה נמחקה בהצלחה', 'success');
        } catch (err) {
          showMessage('שגיאה במחיקת שעה: ' + err.message, 'error');
        }
      });
      actions.appendChild(btnDelete);

      slotElem.appendChild(actions);
      return slotElem;
    }

    // פתח מודל עריכה עם נתוני השעה שנבחרה
    function openEditModal(dateStr, oldTime) {
      slotBeingEdited = {date: dateStr, oldTime};
      editTimeInput.value = oldTime;
      editModal.classList.add('active');
      editTimeInput.focus();
    }

    // סגור מודל עריכה
    function closeEditModal() {
      editModal.classList.remove('active');
      slotBeingEdited = null;
      editTimeInput.value = '';
    }

    // שמור עריכה
    modalSaveBtn.addEventListener('click', async () => {
      const newTime = editTimeInput.value.trim();
      if (!newTime.match(/^([01]\d|2[0-3]):([0-5]\d)$/)) {
        showMessage('פורמט הזמן לא תקין. השתמש HH:MM', 'error');
        return;
      }
      if (!slotBeingEdited) return closeEditModal();

      modalSaveBtn.disabled = true;
      try {
        await fetch('/overrides_edit_slot', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            date: slotBeingEdited.date,
            oldTime: slotBeingEdited.oldTime,
            newTime: newTime
          })
        });
        await fetchOverrides();
        renderSlotsForDate(slotBeingEdited.date);
        showMessage('השעה עודכנה בהצלחה', 'success');
        closeEditModal();
      } catch (err) {
        showMessage('שגיאה בעריכת שעה: ' + err.message, 'error');
      } finally {
        modalSaveBtn.disabled = false;
      }
    });

    modalCancelBtn.addEventListener('click', () => {
      closeEditModal();
    });

    // סגור המודל בלחיצה מחוץ לתוכן
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        closeEditModal();
      }
    });

    // בקשה לשרת לעדכון נתוני overrides
    async function fetchOverrides() {
      try {
        const res = await fetch('/api/overrides');
        const data = await res.json();
        overrides = data;
      } catch (err) {
        showMessage('שגיאה בטעינת שינויים: ' + err.message, 'error');
      }
    }

    // מחזיר מערך שעות חצי שעה בין 08:00 ל-20:00
    function getAllTimesForDate(dateStr) {
      // אפשר להחליף בנתוני שגרה בסיסיים אם רוצים
      const times = [];
      for(let h=8; h<=20; h++) {
        times.push(`${h.toString().padStart(2,'0')}:00`);
        if(h !== 20) times.push(`${h.toString().padStart(2,'0')}:30`);
      }
      return times;
    }

    // אתחל
    (async () => {
      // מחק אם יש נתוני מוטמע לנסות לטעון מהשרת
      await fetchOverrides();

      // אם אין נתונים מוטמעים בשטח (כמו baseSchedule) אפשר להוסיף בעתיד
      baseSchedule = {}; // כאן אפשר למלא משרת או לשלב נתונים

      createDateButtons();
    })();

  </script>
</body>
</html>
