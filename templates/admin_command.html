<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> HairBoss - Admin Command</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; background: #eef2f7; color: #222; direction: rtl; }
  h1, h2 { text-align: center; }
  .section { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px #ccc; margin-bottom: 30px; }
  .day-container { border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; padding: 10px; }
  .day-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
  .day-header span { font-weight: bold; font-size: 1.1em; }
  .times-container { margin-top: 10px; display: none; }
  .times-container.active { display: block; }
  .time-btn {
    display: inline-block; margin: 5px 5px 5px 0; padding: 5px 10px; border-radius: 5px;
    background: #3498db; color: white; cursor: pointer; position: relative;
  }
  .time-btn.disabled { background: #aaa; cursor: default; text-decoration: line-through; }
  .time-btn .actions {
    position: absolute; top: 2px; left: 2px; font-weight: bold; font-size: 0.9em; display: flex; gap: 5px;
  }
  .time-btn .actions button {
    background: transparent; border: none; color: white; cursor: pointer; font-weight: bold;
    padding: 0 3px;
  }
  .add-time-input { margin-top: 10px; }
  button.add-btn { background: #2ecc71; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
  button.toggle-day-btn { background: #e67e22; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
  button.toggle-day-btn.enabled { background: #27ae60; }
  .top-nav { overflow: hidden; margin-bottom: 20px; }
  .top-nav a { margin-left: 10px; text-decoration: none; color: #2980b9; }
  .logout { float: left; font-weight: bold; color: red; }
</style>
<script>
function toggleSection(id) {
  const elem = document.getElementById(id);
  elem.classList.toggle('active');
}

// ---  砖注转 专专转   08:00 -20:00 爪 砖注 ---
function generateDefaultTimes() {
  const times = [];
  for(let h=8; h<20; h++) {
    times.push(`${h.toString().padStart(2,'0')}:00`);
    times.push(`${h.toString().padStart(2,'0')}:30`);
  }
  times.push('20:00'); // 住祝  20:00 拽
  return times;
}

// --- 砖专 砖注转 ---

async function toggleWeeklyDay(day_key, enabled) {
  await fetch('/weekly_toggle_day', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({day_key, enabled})
  });
  location.reload();
}

async function updateWeeklySchedule(action, day_key, time) {
  const res = await fetch('/weekly_schedule', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action, day_key, time })
  });
  const data = await res.json();
  if (data.error) alert('Error: ' + data.error);
  else location.reload();
}

async function addWeeklyTime(day_key) {
  const input = document.getElementById('weekly-add-' + day_key);
  const time = input.value;
  if (!time) { alert(' 专 砖注 住驻'); return; }
  await updateWeeklySchedule('add', day_key, time);
}

async function removeWeeklyTime(day_key, time) {
  if (!confirm(`住专 转 砖注 ${time}  ?`)) return;
  await updateWeeklySchedule('remove', day_key, time);
}

async function toggleWeeklyTime(day_key, time, enable) {
  if(enable) {
    await updateWeeklySchedule('add', day_key, time);
  } else {
    await updateWeeklySchedule('remove', day_key, time);
  }
}

// --- 砖  驻注 ---

async function toggleOverrideDay(date, enabled) {
  await fetch('/overrides_toggle_day', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({date, enabled})
  });
  location.reload();
}

async function updateOverrides(action, date, time=null) {
  const body = { action, date };
  if(time) body.time = time;
  const res = await fetch('/overrides', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.error) alert('Error: ' + data.error);
  else location.reload();
}

async function addOverrideTime(date) {
  const input = document.getElementById('override-add-' + date);
  const time = input.value;
  if (!time) { alert(' 专 砖注 住驻'); return; }
  await updateOverrides('add', date, time);
}

async function removeOverrideTime(date, time) {
  if (!confirm(`住专 转 砖注 ${time} 转专 ?`)) return;
  await updateOverrides('remove', date, time);
}

async function clearOverrideDate(date) {
  if (!confirm(`拽转 转  砖 转专 ${date}?`)) return;
  await updateOverrides('clear', date);
}

async function toggleOverrideTime(date, time, enable) {
  if(enable) {
    await updateOverrides('add', date, time);
  } else {
    await updateOverrides('remove', date, time);
  }
}

</script>
</head>
<body>

<div class="top-nav">
  <a href="/" target="_blank"> 爪驻 注 转</a>
  <a href="/bot_knowledge">锔 注专转 注 </a>
  <a href="/appointments"> 爪驻 转专</a>
  <a href="/logout" class="logout"> 转转拽</a>
</div>

<h1> HairBoss -  砖专 砖</h1>

<div class="section">
  <h2>砖专 砖注转 (砖注转 驻注转 拽注转)</h2>

  {% set day_names = ["专砖","砖","砖砖","专注","砖","砖砖","砖转"] %}
  {% set default_times = [] %}
  {% for hour in range(8,20) %}
    {% for minute in [0,30] %}
      {% set _ = default_times.append("%02d:%02d" | format(hour, minute)) %}
    {% endfor %}
  {% endfor %}
  {% do default_times.append("20:00") %}

  {% for day_key in ['0','1','2','3','4','5','6'] %}
  <div class="day-container">
    <div class="day-header" onclick="toggleSection('weekly-times-{{day_key}}')">
      <span>{{ day_names[day_key|int] }}</span>
      <button class="toggle-day-btn {% if weekly_schedule[day_key]|length > 0 %}enabled{% endif %}"
        onclick="event.stopPropagation(); toggleWeeklyDay('{{day_key}}', {{ 'false' if weekly_schedule[day_key]|length > 0 else 'true' }})">
        {% if weekly_schedule[day_key]|length > 0 %} {% else %}驻注 {% endif %}
      </button>
    </div>
    <div class="times-container" id="weekly-times-{{day_key}}">
      {% if weekly_schedule[day_key]|length == 0 %}
        <em> </em>
      {% else %}
        {% for time in default_times %}
          {% set enabled = time in weekly_schedule[day_key] %}
          <button
            class="time-btn {% if not enabled %}disabled{% endif %}"
            onclick="event.stopPropagation(); toggleWeeklyTime('{{day_key}}', '{{time}}', {{ 'true' if not enabled else 'false' }})">
            {{ time }}
            <span class="actions">
              <button title="住专" onclick="event.stopPropagation(); removeWeeklyTime('{{day_key}}', '{{time}}')">锔</button>
            </span>
          </button>
        {% endfor %}
      {% endif %}
      <div class="add-time-input">
        <input type="time" id="weekly-add-{{day_key}}" />
        <button class="add-btn" onclick="addWeeklyTime('{{day_key}}')">住祝 砖注</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="section">
  <h2>砖  驻注 驻 转专</h2>

  {% if overrides|length == 0 %}
    <em> 砖  驻注</em>
  {% else %}
    {% for date, override in overrides.items() %}
    <div class="day-container">
      <div class="day-header" onclick="toggleSection('override-times-{{date}}')">
        <span>{{ date }}</span>
        <button class="toggle-day-btn {% if override.remove == ['__all__'] %} {% else %}enabled{% endif %}"
          onclick="event.stopPropagation(); toggleOverrideDay('{{date}}', {{ 'false' if override.remove == ['__all__'] else 'true' }})">
          {% if override.remove == ['__all__'] %}驻注 {% else %} {% endif %}
        </button>
      </div>
      <div class="times-container" id="override-times-{{date}}">
        <div><strong>住驻:</strong></div>

        {% set override_add = override.add %}
        {% set override_remove = override.remove %}
        {% if override_remove == ['__all__'] %}
          <em> </em>
        {% endif %}

        {% for time in default_times %}
          {% set added = time in override_add %}
          {% set removed = time in override_remove or override_remove == ['__all__'] %}
          <button
            class="time-btn {% if removed %}disabled{% endif %}"
            onclick="event.stopPropagation(); toggleOverrideTime('{{date}}', '{{time}}', {{ 'true' if not added else 'false' }})">
            {{ time }}
            <span class="actions">
              {% if added %}
                <button title="住专" onclick="event.stopPropagation(); removeOverrideTime('{{date}}', '{{time}}')">锔</button>
              {% endif %}
            </span>
          </button>
        {% endfor %}

        <div class="add-time-input">
          <input type="time" id="override-add-{{date}}" />
          <button class="add-btn" onclick="addOverrideTime('{{date}}')">住祝 砖注</button>
        </div>

        <div style="margin-top:10px;">
          <button class="remove-btn" onclick="clearOverrideDate('{{date}}')">拽 转  砖 转专 </button>
        </div>
      </div>
    </div>
    {% endfor %}
  {% endif %}
</div>

<div style="text-align:center; margin-top:30px;">
  <a href="/">专 祝 转</a>
</div>

</body>
</html>
