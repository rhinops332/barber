<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ניהול HairBoss</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #eef2f7; color: #222; direction: rtl; }
  h1, h2 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
  th { background: #3498db; color: white; }
  input[type="time"], input[type="text"] { width: 80px; padding: 5px; }
  button { padding: 5px 10px; margin: 0 2px; border: none; border-radius: 4px; cursor: pointer; }
  .add-btn { background: #2ecc71; color: white; }
  .remove-btn { background: #e74c3c; color: white; }
  .edit-btn { background: #f39c12; color: white; }
  .section { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 8px #ccc; margin-bottom: 30px; }
  a { text-decoration: none; color: #2980b9; }
  .logout { float: left; font-weight: bold; color: red; }
  .top-nav { overflow: hidden; margin-bottom: 20px; }
</style>
<script>
async function updateWeeklySchedule(action, day_key, time, new_time=null) {
  const body = { action, day_key, time };
  if (new_time) body.new_time = new_time;

  const res = await fetch('/weekly_schedule', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.error) alert('Error: ' + data.error);
  else location.reload();
}

async function updateOverrides(action, date, time=null) {
  const body = { action, date };
  if(time) body.time = time;

  const res = await fetch('/overrides', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.error) alert('Error: ' + data.error);
  else location.reload();
}
</script>
</head>
<body>

<div class="top-nav">
  <a href="/" target="_blank">🏠 צפייה בעמוד ההזמנות</a>
  <a href="/bot_knowledge">✏️ עריכת ידע הבוט</a>
  <a href="/appointments">📋 צפייה בתורים</a>
  <a href="/logout" class="logout">🔓 התנתק</a>
</div>

<h1>ניהול HairBoss</h1>

<div class="section">
  <h2>שגרה שבועית (זמני עבודה קבועים)</h2>
  <table>
    <thead>
      <tr>
        <th>יום בשבוע</th>
        <th>שעות זמינות</th>
        <th>הוספה</th>
      </tr>
    </thead>
    <tbody>
      {% for day_key in ['0','1','2','3','4','5','6'] %}
        <tr>
          <td>
            {% set day_names = ["שני","שלישי","רביעי","חמישי","שישי","שבת","ראשון"] %}
            {{ day_names[day_key|int] }}
          </td>
          <td>
            {% for time in weekly_schedule.get(day_key, []) %}
              {{ time }}
              <button class="remove-btn" onclick="updateWeeklySchedule('remove','{{day_key}}','{{time}}')">✖️</button>
              <br/>
            {% else %}
              <em>אין זמינות</em>
            {% endfor %}
          </td>
          <td>
            <input type="time" id="add-time-{{day_key}}" />
            <button class="add-btn" onclick="
              const t = document.getElementById('add-time-{{day_key}}').value;
              if(t) updateWeeklySchedule('add','{{day_key}}',t);
              else alert('נא לבחור שעה להוספה');
            ">הוסף</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>שינויים חד-פעמיים (הוספה/הסרה של שעות ליום מסוים)</h2>
  <table>
    <thead>
      <tr>
        <th>תאריך</th>
        <th>הוספה</th>
        <th>הסרה</th>
        <th>ניקוי כל השינויים</th>
      </tr>
    </thead>
    <tbody>
      {% for date, override in overrides.items() %}
        <tr>
          <td>{{ date }}</td>
          <td>
            {% for t in override.add %}
              {{ t }} <button class="remove-btn" onclick="updateOverrides('remove','{{date}}','{{t}}')">הסר</button><br/>
            {% else %}
              <em>אין</em>
            {% endfor %}
            <input type="time" id="add-{{date}}" />
            <button class="add-btn" onclick="
              const t = document.getElementById('add-{{date}}').value;
              if(t) updateOverrides('add','{{date}}',t);
              else alert('נא לבחור שעה להוספה');
            ">הוסף</button>
          </td>
          <td>
            {% for t in override.remove %}
              {{ t }} <button class="remove-btn" onclick="updateOverrides('add','{{date}}','{{t}}')">בטל הסרה</button><br/>
            {% else %}
              <em>אין</em>
            {% endfor %}
          </td>
          <td>
            <button class="remove-btn" onclick="if(confirm('בטוח שברצונך לנקות את כל השינויים בתאריך זה?')) updateOverrides('clear','{{date}}')">נקה</button>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="4"><em>אין שינויים חד-פעמיים</em></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="section">
  <h2>תורים שהוזמנו</h2>
  <table>
    <thead>
      <tr>
        <th>תאריך</th>
        <th>שעה</th>
        <th>שם</th>
        <th>טלפון</th>
        <th>שירות</th>
        <th>מחיר</th>
      </tr>
    </thead>
    <tbody>
      {% for date, appts in appointments.items() %}
        {% for appt in appts %}
          <tr>
            <td>{{ date }}</td>
            <td>{{ appt.time }}</td>
            <td>{{ appt.name }}</td>
            <td>{{ appt.phone }}</td>
            <td>{{ appt.service }}</td>
            <td>{{ appt.price }} ₪</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="6"><em>אין תורים</em></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div style="text-align:center; margin-top:30px;">
  <a href="/">חזרה לדף הבית</a>
</div>

</body>
</html>

